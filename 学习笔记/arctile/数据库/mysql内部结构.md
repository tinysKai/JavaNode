#### mysql内部结构图
![mysql](https://github.com/tinysKai/Note/blob/master/image/article/2018/0709//mysql.jpg)  
+ Connectors：连接器。接收不同语言的Client交互
+ Management Service & Utilities：系统管理和控制工具
+ Connection Pool: 连接池。管理用户连接
+ SQL Interface: SQL接口。接受用户的SQL命令，并且返回用户需要查询的结果
+ Parser: 解析器。验证和解析SQL语句成内部数据结构
+ Optimizer: 查询优化器。为查询语句选择合适的执行路径
+ Cache和Buffer：查询缓存。缓存查询的结果，有命中即可直接返回
+ Engine：存储引擎。MySQL数据最后组织并存储成具体文件

#### mysql查询流程
![mysql](https://github.com/tinysKai/Note/blob/master/image/article/2018/0709//mysql1.PNG)    

MySQL整个查询执行过程
+ 客户端向MySQL服务器发送一条查询请求
+ 服务器首先检查查询缓存，如果命中缓存，则立刻返回存储在缓存中的结果。否则进入下一阶段
+ 服务器进行SQL解析、预处理、再由优化器生成对应的执行计划
+ MySQL根据执行计划，调用存储引擎的API来执行查询
+ 将结果返回给客户端，同时缓存查询结果

>语法解析和预处理  
MySQL通过关键字将SQL语句进行解析，并生成一颗对应的解析树。  
这个过程解析器主要通过语法规则来验证和解析。比如SQL中是否使用了错误的关键字或者关键字的顺序是否正确等等。  
预处理则会根据MySQL规则进一步检查解析树是否合法。比如检查要查询的数据表和数据列是否存在等等。

>返回结果给客户端  
查询执行的最后一个阶段就是将结果返回给客户端。  
即使查询不到数据，MySQL仍然会返回这个查询的相关信息，比如改查询影响到的行数以及执行时间等等。
结果集返回客户端是一个增量且逐步返回的过程。  
有可能MySQL在生成第一条结果时，就开始向客户端逐步返回结果集了。  
这样服务端就无须存储太多结果而消耗过多内存，也可以让客户端第一时间获得返回结果。  
需要注意的是，结果集中的每一行都会以一个满足①中所描述的通信协议的数据包发送，再通过TCP协议进行传输，在传输过程中，可能对MySQL的数据包进行缓存然后批量发送。

#### 客户端/服务端通信协议
MySQL客户端/服务端通信协议是“半双工”的：在任一时刻，要么是服务器向客户端发送数据，要么是客户端向服务器发送数据，这两个动作不能同时发生。  
一旦一端开始发送消息，另一端要接收完整个消息才能响应它，所以我们无法也无须将一个消息切成小块独立发送，也没有办法进行流量控制。
