## Mysql连接数设定指引

| 存储类型 | 最大连接数 | 最大可用             | 评估方法(统一假设前端Web Sever有100台)                       | 注意事项                                                     |
| -------- | ---------- | -------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| MySQL    | 3000       | 2980预留20个给管理用 | Java: 最大连接数= 2900 / 100 约 29  下面的统一： idle = 3 initial = 1 idleConnectTestPeriod=100（数据库是86400秒 idle timeout） | 分库分表： druid配置的连接是按照DB分配，MySQL 3000连接是实例的，如果一个实例4个DB，那么java的最大连接数=3000/400为什么db的wait_timeout=86400： （1）避免频繁的连接创建，如需要连接的时候db已经断了，应用抛异常，再创建新的连接并重新获取DNS记录(平均RT 50ms) （2）大促并发来了，创建连接会有性能问题，为此idle=3（根据业务流量合理设置）但不能等于最大连接数 |
| Redis    | 10000      | 10000                | Java: 最大连接数= 10000 / 100                                |                                                              |
| Memcache | 65535      | 65535                | Java: 最大连接数= 65535 / 100                                |                                                              |

 

## 扩容时需注意减少对应的连接数

| 20台服务器                                             | 扩容到60台                                            |
| ------------------------------------------------------ | ----------------------------------------------------- |
| Redis：配置 10000 / 20 = 500                           | Redis：配置 10000 / 60 = 160                          |
| MySQL：配置 2900 / 20 = 145 （idle =3 和 initial = 3） | MySQL：配置 2900 / 60 = 48 （idle =3 和 initial = 1） |



## MySQL 为何设置 3000 这么小的最大连接数？

1. 众所周知，连接的创建和销毁，成本是很高的，每一个连接的创建都需要获取系统和OS层的资源（内存，文件句柄等）。
2. 数据库服务器 CPU 有 32 个core ，最大并发只能是32 ，意思是**同一时刻**只能是 32条SQL 在运行，**所以连接数再大，还是不能超过硬性条件 32 并发** 。这里要注意：业务上说支持多少并发，应该理解为支持多少QPS（每秒处理请求数）。
3. 每一个MySQL连接里占用内存为：min 256 k  max 64M，使用多少，主要看SQL获取的数据，以及如果有排序，排序所需要的内存空间，当超过64M后，就会生成临时文件存放在文件系统的指定的临时文件夹里。
4. 一台数据库服务器物理内存是128G，线上统一MySQL锁定 80G 的内存，余下45G给系统资源和MySQL连接资源，3000个连接满了，就是 min 750MB max 192GB的内存，连接多了，超过45G就会产生SWAP从而影响整体性能。

