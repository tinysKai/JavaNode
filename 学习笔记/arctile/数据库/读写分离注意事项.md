# 读写分离主义事项

**读写分离的好处**：

1. 在相对简单的付出下（只需要做读写分离，相对于sharding 而言，开发简单很多），可以解决系统的scalability的问题；
2. 对于写的高可用相对要求低，对读的高可用要求/读的qps 要求非常高（比如用户登陆，移动的配置类型信息）可以很容易的实现系统扩展新问题
3. 很容易实现读库的99.999%的高可用
4. 可以某种程度上，降低大查询/报表类应用，对在线系统的压力；（**比如wms/tms之类，不过不鼓励这种做法**）

**读写分离的坏处：**

1. 应用开发需要清楚知道，什么时候读主库，什么时候读从库；**如果主从延迟，导致异常单，应该作为bug处理；**
2. 对于应用开发，某种程度上，对开发的要求更高：不能写大job（从库一定delay），不能写大SQL（从库也很容易delay）；
3.  需要处理从库delay 的exception；何时回源主库；大部分是不能/不应该回源的；集中回源很容易压死主库；
4. 容易让dev abuse系统；不做过多优化；
5. 降低主库的写容量，当TPS超过6k，从库就会延迟逐步增加，而主库的TPS其实可以去到1.5w甚至2w



**总体判断的guideline：**

1. 读写比率，**必须在10:1 以上（建议20:1以上），才有可能考虑读写分离**；不然原则上，不同意读写分离，不管如何还是**要求避免延迟，比如：防止延迟的时候突发failover，那要么抛弃延迟的数据（如果硬件故障，大事务产生的大量binlog来不及传送，必然丢数据），要么等延迟过去拉长了故障恢复时间**；
2. 读写分离的数据库，必**须在读库前面，有LVS，来虚拟化读库的IP**；原则上，10:1的读写分离，读库的压力会大大于写库；也需要多个数据库服务器来支撑；也需要LVS来掩盖和解决后端数据库服务器的维护问题（基本上读库可以逻辑上always online） 
3.  读写分离的应用，**程序要能够handle延迟的情况，****必须能够容忍读库delay 3~5s;** 如果不能容忍，请不要连接从库；
4.  读写分离的主库，在系统设计支撑的容量，**3年内，写库应该不需要sharding 拆分**；不然，就是白白引入先读写分离，然后在主库sharding的复杂度；
5. 读写分离的应用，**不能因为读写分离了，就可以滥用系统**；在主库的大事务，和在从库的大SQL，都会导致slave 的较大规模的delay； 
6. 读写分离的应用，**对于一个transaction里面的或者有强一致性依赖的，不能一下子去从库，一下子去主库；**一个transaction 里面的信息，必须都是consistent的；属于ms级别的；主从复制必然有这个delay的；
7. 原则上，读写分离的数据库，尽量不要让主库过于大（2个TB）；
8. 读写分离，**不应该作为报表的标准解决方案**；报表类型的应用（后端系统，比如vis, tps, ods, tms, wms等较多）原则上，**应该考虑通过hadoop 来解决**；**MySQL天然不适合报表类型的应用**；在线系统和报表系统，天然应该分离；
9. 读写分离应用： 对于cache侧有可能回源的应用， 可以考虑选择读写分离， **所有的读回源必须到 LVS vip**

**做了分库分表的数据库，不做读写分离**

原因：
（1）从库是用于容灾HA的，如果承担了流量压力，那么谈不上HA了，当从库挂了，从库的流量到了主库，主库可能承担不了从库的压力一起挂了，那么从库一挂，就大家都挂
（2）如果从库要再做HA，就大大增加了硬件成本的投入以及维护成本，比如最低配的1主2从，你有10个分库就多10台从库以及负载均衡设备
  (3)  目前机房机柜是稀缺资源，就算有钱买机器，也不一定能拿到机柜资源



 **常见的slave delay的原因：**

1. 大job，一个update 几万条几十万条记录的；
2. 表没有主键，导致从库复制每一条记录的DML都会做全表扫描
3. slave 大SQL，比如频繁的大量的复杂join，耗尽磁盘的io能力或者耗光CPU资源；slave delay；
4. DBA维护操作，比如大表的online DDL，或者dba 晚上的归档的job； --应该禁止；我们online ddl要求控制速度；归档也要控制速度和并发；麻烦的是两个同时kick off的时候；
5. 网络或者系统问题；比如跨机房网络，同机房网络不稳定，系统不稳定（机器故障）；
6. MySQL bug； 
7. 频繁对Text字段的表的读写，会把IO资源耗光，哪怕是flash卡
8. 一些框架，查询也会发起事务，如set autocommit=0，又不关闭连接，到发布需要做ddl变更时，就会导致表锁延迟