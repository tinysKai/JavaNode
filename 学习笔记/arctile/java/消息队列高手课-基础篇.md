## 消息队列高手课-基础篇

### 开场

消息队列最常被使用的三种场景：

+ 异步处理
+ 流量控制
+ 服务解耦

引入消息队列带来的问题:

+ 延迟
+ 系统复杂度
+ 数据不一致

### 生态

#### 特性

作为一款及格的消息队列产品，必须具备的几个特性包括：

+ 消息的可靠传递：确保不丢消息；
+ Cluster：支持集群，确保不会因为某个节点宕机导致服务不可用，当然也不能丢消息；
+ 性能：具备足够好的性能，能满足绝大多数场景的性能要求。

#### 比较

| 产品     | 编程语言    | 性能                         | 优势                                                         | 缺点                                                         |
| -------- | ----------- | ---------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| RabbitMQ | Erlang      | 每秒处理几万到十几万的消息   | 1.轻量级,开箱即用<br />2.交换机模块(exchange),能灵活实现路由规则 | 1.消息堆积处理不好<br />2.性能相对较差<br />3.Erlang语言偏门,二次开发难度大 |
| RocketMQ | java        | 每秒钟大概能处理几十万条消息 | 1.阿里出品,文档齐全,社区活跃<br />2.多次经历阿里双十一考验,性能,稳定性和可靠性有保证<br />3.毫秒级响应 | 国内出品,相应合作衍生品相比kafka较差                         |
| Kafka    | Scala和java | 每秒钟可以处理几十万条消息   | 1.与周边生态兼容性最好<br />2.基于异步和批量,性能好          | 1.由于是批量才发送消息因此若每秒消息数少时延反而高,不太适合在线业务 |

总结

+ 如果说，消息队列并不是你将要构建系统的主角之一，你对消息队列功能和性能都没有很高的要求，只需要一个开箱即用易于维护的产品，我建议你使用 RabbitMQ。
+ 如果你的系统使用消息队列主要场景是处理在线业务，比如在交易系统中用消息队列传递订单，那 RocketMQ 的低延迟和金融级的稳定性是你需要的。
+ 如果你需要处理海量的消息，像收集日志、监控信息或是前端的埋点这类数据，或是你的应用场景大量使用了大数据、流计算相关的开源产品，那 Kafka 是最适合你的消息队列。

### 分布式事务

分布式事务就是要在分布式系统中的实现事务。消息队列实现分布式事务举个订单与购物车的案例,在提交订单后清除购物车,如下图:

![27ebf12e0dc79e00e1e42c8ff0f4e2e6.jpg](http://ww1.sinaimg.cn/large/8bb38904gy1ggf998o6f2j22wy0zptev.jpg)

首先，订单系统在消息队列上开启一个事务。然后订单系统给消息服务器发送一个“半消息”，这个半消息不是说消息内容不完整，它包含的内容就是完整的消息内容，半消息和普通消息的唯一区别是，在事务提交之前，对于消费者来说，这个消息是不可见的。

上述方案在第四步提交/回滚消息若失败时,消息引擎是无法知道具体的结果,而不同的消息引擎有不同的处理方式 :

+ Kafka 的解决方案比较简单粗暴，直接抛出异常，让用户自行处理。
+ RocketMQ可提供反查接口来让RocketMQ判断消息最终是否要提交还是回滚

#### RocketMQ的反查机制

如果 Producer 也就是订单系统，在提交或者回滚事务消息时发生网络异常，RocketMQ 的 Broker 没有收到提交或者回滚的请求，Broker 会定期去 Producer 上反查这个事务对应的本地事务的状态，然后根据反查结果决定提交或者回滚这个事务。

在我们这个例子中，反查本地事务的逻辑也很简单，我们只要根据消息中的订单 ID，在订单库中查询这个订单是否存在即可，如果订单存在则返回成功，否则返回失败。RocketMQ 会自动根据事务反查的结果提交或者回滚事务消息。

这个反查本地事务的实现，并不依赖消息的发送方，也就是订单服务的某个实例节点上的任何数据。这种情况下，即使是发送事务消息的那个订单服务节点宕机了，RocketMQ 依然可以通过其他订单服务的节点来执行反查，确保事务的完整性。

![11ea249b164b893fb9c36e86ae32577a.jpg](http://ww1.sinaimg.cn/large/8bb38904gy1ggf9fvcun2j22v615eq9k.jpg)

