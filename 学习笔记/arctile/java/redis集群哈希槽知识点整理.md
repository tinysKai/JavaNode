#### redis集群哈希槽知识点整理

#### 背景

Redis Cluster 将所有数据划分为 16384 的 slots,每个节点负责其中一部分槽位,槽位的信息存储于每个节点中,它不需要另外的分布式存储来存储节点槽位信息。当客户端来链接集群时也会得到一份集群的槽位配置信息表,这样其查询某个key时可以直接定位到目标节点

#### 图解

![180bf5a4-be98-4d3c-a2c6-261295b5e8ca-2575962.jpg](http://ww1.sinaimg.cn/large/8bb38904gy1gbclb00ycwj20u00e9wjr.jpg)

#### 哈希槽的优势

- 解耦数据和节点之间的关系，简化了节点扩容和收缩难度。
- 节点自身维护槽的映射关系，不需要客户端或者代理服务维护槽分区元数据
- 支持节点、槽和键之间的映射查询，用于数据路由，在线集群伸缩等场景。

#### 扩容与缩容

槽是 Redis 集群管理数据的基本单位，集群伸缩就是槽和数据在节点之间的移动。

新增节点

![adf33cef-7385-44a1-afaf-ae34a9843dce-2575962.jpg](http://ww1.sinaimg.cn/large/8bb38904gy1gbclcw4azlj20gq0dvdk9.jpg)

缩减节点

> Redis 集群使用 cluster forget { downNodeId } 命令来将指定的节点加入到禁用列表中，在禁用列表内的节点不再发送 Gossip 消息。

![931ce99e-6bf3-4bff-b6fc-04ac0acf3fd1-2575962.jpg](http://ww1.sinaimg.cn/large/8bb38904gy1gbcld6r1nhj20gv0dnn0u.jpg)

#### 数据迁移

- 从源节点获取内容 => 存到目标节点 => 从源节点删除内容。
- 迁移过程是同步的，在目标节点执行restore指令到原节点删除key之间，原节点的主线程会处于阻塞状态，直到key被成功删除。
- Redis 迁移的单位是槽，Redis 一个槽一个槽进行迁移，当一个槽正在迁移时，这个槽就处于中间过渡状态。这个槽在原节点的状态为migrating，在目标节点的状态为importing，表示数据正在从源流向目标。
- 使用migrate指令迁移,该指令是同步的,会阻塞其它命令的执行

#### 指令

一个槽位是有多个key的,在迁移一个槽位时存在新旧两个节点都存在部分槽位节点的场合,此时redis将配合ASK和MOVE指令来寻找数据

- ASK指令 - 当迁移进行中时,旧节点不存在值时,需将请求转发到新节点去判断到底是没这个key还是这个key已经迁移完成了
- MOVE指令 - 槽位不在当前节点,直接指明新槽位的节点,让客户端请求新节点并更新缓存的槽位表信息