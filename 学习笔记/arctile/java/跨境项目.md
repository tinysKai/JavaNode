## 跨境项目

#### 跨境支付

跨境支付就是中国消费者在网上购买国外商家产品或国外消费者购买中国商家产品时，由于币种的不一样，就需要通过一定的结算工具和支付系统实现两个国家或地区之间的资金转换，最终完成交易。

#### 系统业务

+ 支撑唯品国际业务
+ 降低跨境支付结算的成本
+ 具有跨境人民币，跨境外汇结算功能

#### 系统接口分类

+ 跨境人民币
+ 跨境外汇

​      人民币跨境支付是：我国境内的商户或者是境外的商户均以人民币作为支付以及结算的币种。境外的商户/用户开设人民币账户，与境内的用户/商户通过支付机构直接以人民币进行交易，不仅减少货币汇兑的汇差损失风险，还大大缩短了结算周期。

**资金出境资金流**

![](https://s2.ax1x.com/2019/06/28/ZK7thV.png)

**资金入境资金流**

![](https://s2.ax1x.com/2019/08/26/mfAvuT.png)

#### 外币资金入境

![](https://s2.ax1x.com/2019/06/28/ZKOdeg.png)

#### 系统模块

+ osp-cap-cbs-quartz.bfintra.com(定时任务系统)
+ osp-cap-cbs-msg.bfintra.com(报文引擎)
+ cap-cbs-mgr.bfintra.com (后台系统)

#### 总体业务

![](https://s2.ax1x.com/2019/06/28/ZMZhJx.png)



#### 人民币交互流程

![ZMmHIA.png](https://s2.ax1x.com/2019/06/28/ZMmHIA.png)

#### 人民币资金流流向

![](https://s2.ax1x.com/2019/07/04/ZU82VS.png)

#### 人民币系统概念解释

结算单 : 系统同一批次的结算概念,将同一个excel导入的交易记录作为同一单处理

打包  : 将多个结算单汇总到一个打包中,目的方便多个结算单的资金调拨只需要调拨一次以及添加审核流程

资金调拨 :   将资金打款到唯品支付备付金银行6065账户.调拨的金额是以打包的金额为准.打包的纬度是根据`货币种类+渠道`来分类的

------------------------------------**下面的定时任务跟打包已经没关系了,都是跟结算单走了**------------------------------------

划款指令 : 由于工行的同一个交易明细文件excel有条数限制(99999条),所以同一个结算单需分成多个批次.计算指令金额的时候会在汇总的那个SQL中计算轧差保存到`conver_rmb_settlement_amount`

上送报文 : 上送申报交易明细，将生成的明细文件放到指定的sftp(主要是看是否有明细命中黑名单).**上送时将金额从分转换为元**,并且将明细表里面的退款类型的金额变为负数.然后总额计算汇总金额(这里的金额只是计算但没用到校验)

交易申报 :  通知银行告知我们已将文件放置到sftp上,可以处理这些申报文件了

银行回调 :  通过Socket监听解析IO流,读取其中的IO流数据的文件路径,并解析对应的回盘文件(银行只是对我们上传的回盘文件进行进行黑名单校验,校验通过会在每一条明细后加上`00`),最终我们会根据银行返回的校验通过的总金额进行解冻以及转账





#### 跨境外汇交互流程

![](https://s2.ax1x.com/2019/07/03/ZY2JUA.png)

#### 外汇概念解释

**原始交易明细文件** 　:　将当日需要付汇的原始交易明细信息提供给银行。

**原始交易回盘文件**　：　与原交易明细文件一一对应。若明细全部审核通过，则无需明细部分，仅有汇总部分。汇总部分的“扫描命中总笔数”为0，“字段校验未通过总笔数”为0.当原文件中交易明细存在命中、或校验未通过，则反馈汇总部分及明细部分。

**原始交易扫描最终确认结果文件**　：　疑似命中记录在人工甄别后，反馈最终结果。该文件无需和原交易明细文件对应，甄别完成后，定时组文件反馈，该部分原始明细需要合并到第二天的原始明细中再次上送

**付汇文件**　：　根据实际业务需求及交易明细扫描结果，发起多个批次汇款的指令。银行根据接受到的汇出指令和相关信息，将资金汇至境外目标账户。付汇是将钱打款到商户账户中，货币种类是读取的指令表，而指令表值是读明细表

**付汇回盘文件**　：　完成付汇指令的发报处理后，反馈处理结果。该文件与于原付汇文件一一对应

**国际收支申报反馈文件** : 银行在向外汇管理局申报付汇数据后，将在外管侧的申报序号反馈给合作方。该申报序号为国际收支集中申报序号。该申报号可以查询汇款申报情况

**结售汇申报文件** 　:　购汇明细，向外管局进行**结售汇**登记,**不涉及资金交易**.当支付时使用购汇,退款时使用结汇.账户是6065账户.

**结售汇申报回盘文件**　：　反馈结售汇文件登记外管结果。反馈内容按照银行登记情况进行反馈，不按照原结售汇登记文件的维度来组织

**付汇** : 金融机构从其外汇帐户中或将其购买的外汇向境外支付的行为

**结售汇** : 结售汇是结汇与售汇的统称。

- 结汇即“外汇结算”，是指外汇收入所有者将其外汇收入出售给外汇指定银行，外汇指定银行按一定汇率付给等值的本币的行为。
- 售汇即“外汇出售”，是指外汇指定银行将外汇卖给外汇使用者，并根据交易行为发生之日的人民币汇率收取等值人民币的行为。

**购汇** : 当我们发生外币交易后需要支付外币时用人民币去购换成外币支付的一种行为就称之为购汇了。

**锁汇** : 锁汇就是锁定汇率，在银行中这个业务叫远期结售汇。在汇率波动频繁的情况下，银行为企业办理锁定汇率的操作。在结汇当天不是按照当天的外汇牌价，而是按照之前确定的汇率进行结汇。



#### 外汇定时器描述

`原始明细文件与付汇文件 一一对应`

原始文件上送 : 上送明细表数据

原始文件回盘 :　银行返回存疑的明细或者拒绝的明细，我们需将这些明细从划款指令中剔除．注意项目里面会在明细文件返回后执行购汇操作.购汇完会记录银行返回的时机购汇汇率等,然后调用记账系统进行**购汇记账**.

上送付汇文件以及通知 :  先查询购汇状态,若购汇成功后则进行生成付汇文件以及上送到sftp,并调用银行的付汇通知接口

付汇回盘 :  回盘后先更根据划款指令号新明细表,然后根据明细数据更新指令表的汇总数据,

















